# Лаба 4

17.02.20

- [Лаба 4](#Лаба-4)
  - [Нормализация БД](#Нормализация-БД)
  - [Нормальные формы](#Нормальные-формы)
  - [Пример](#Пример)
    - [Решение](#Решение)
  - [Пример 2](#Пример-2)
    - [Решение 2](#Решение-2)
    - [Исправление ситуации](#Исправление-ситуации)

## Нормализация БД

__Нормализация__ - пошаговый обратимый процесс декомпозиции исходного отношения с целью устранения нежелательной функциональной зависимости.

__ФЗ__: A -> B (B функционально зависит от A), если для данного A существует ровно одно значение B.

Пример: A - id университета, B - название университета.

## Нормальные формы

- 1 НФ.
- 2 НФ.
- 3 НФ _(на контрольной можно остановиться здесь)_.
- КНФ - НФ элементарных ключей - промежуточный этап, при котором еще не теряются желательные ФЗ _(на практике нужно останавливаться как минимум здесь)_.
- БКНФ - НФ Бойса-Кодда.
- 4 НФ _(на практике можно остановиться здесь)_.
- 5 НФ.
- 6 НФ.

БКНФ и дальше - потеря желательных ФЗ.

## Пример

Овцы, за которыми присматривают пастухи, живут в загонах. У каждого пастуха есть уникальный идентификатор, имя и размер футболки. Пастух может присматривать за несколькими овцами. Каждый загон управляется только одним пастухом. У каждого загона есть идентификатор, стоимость и вместимость. Каждая овца живет в одном и только в одном загоне. У каждой овцы есть идентификатор, вес и цена.

Надо написать функциональные зависимости.

... -> ...

Задача - определить атрибуты и выставить множество стрелочек.

Зависимости должны быть __нетривиальны__. То есть множества справа и слева не должны пересекаться.

__Неприводимые слева зависимости__ - зависимости, у которых слева нельзя убрать ничего.

### Решение

- man_id -> name, shirt_size.
- box_id -> box_cost, capacity, man_id, name, shirt_size.
- sheep_id -> weight, sheep_cost, man_id, name, shirt_size, box_id, box_cost, capacity.

Иерархическая связь 1:М.

Если правильно упорядочивать, то последняя связь будет содержать все атрибуты будущей БД.

## Пример 2

Волшебники имеют волшебные имена и размер почасовой оплаты за волшебство. Волшебники состоят в магических клубах. Один волшебник может состоять больше чем в одном клубе, а в одном клубе может быть больше, чем один волшебник. Каждый клуб имеет уникальное название. Однако, клубы периодически свои названия меняют. У каждого клуба есть филиалы. У каждого почтовый адрес и контактный номер телефона. Волшебники могут творить магические трюки. У каждого трюка есть уникальный код, описание и степень крутости. Многие волшебники могут выполнять один и тот же трюк, а трюк может выполняться несколькими волшебниками. Каждый исполняемый трюк волшебник исполняет на своем уровне мастерства этого трюка.

_На контрольной не следует вводить id. Лучше спросить._

### Решение 2

- ИД волшебника -> волшебное имя, размер оплаты.
- ИД клуба -> название.
- ИД филиала -> ИД клуба, название клуба, почтовый адрес, номер телефона.
- ИД волшебника, ИД клуба -> имя волшебника, размер оплаты, название клуба.
- Код трюка -> описание, степень крутости.
- ИД волшебника, Код трюка -> уровень мастерства, имя волшебника, размер оплаты, описание, степень крутости.
- ИД филиала, ИД волшебника, Код трюка -> все.

Получается дерево с 2 отношениями М:М, которые не связаны друг с другом.

### Исправление ситуации

Выбросим часть про филиалы.

- Код трюка -> описание, степень крутости.
- ИД волшебника -> волшебное имя, размер оплаты.
- ИД гильдии -> название гильдии.
- ИД клуба -> название, ИД гильдии, название гильдии.
- ИД волшебника, ИД клуба -> имя волшебника, размер оплаты, название клуба.
- ИД волшебника, Код трюка -> уровень мастерства, имя волшебника, размер оплаты, описание, степень крутости.
- ИД клуба, ИД волшебника, Код трюка -> имя волшебника, размер оплаты, название клуба, уровень мастерства, описание, степень крутости, ИД гильдии, название гильдии.

Для построения 1 НФ нужно построить универсальное отношение (т. е. включающее все атрибуты).

Для получения 1 НФ необходимо выделить __первичный ключ__.

Копируем строки и заменяем только одну вещь, чтобы показать что-то.

Нужно найти баланс между отражением всего и экономией времени (на контрольной).

Не должно быть пустот (NULL). На пересечении строки и столбца должно быть атомарное значение (т. е. нельзя перечислять через запятую).

Волшебники. трюки и клубы:

| __ИД волшебника\*__ | __Код трюка\*__ | __ИД клуба\*__ | имя волшебника | размер оплаты | название клуба        | уровень мастерства | описание     | степень крутости | ИД гильдии | название гильдии |
| ------------------- | --------------- | -------------- | -------------- | ------------- | --------------------- | ------------------ | ------------ | ---------------- | ---------- | ---------------- |
| 1                   | 1               | 1              | Мерлин         | 1000          | Клуб Мерлин           | 10                 | Исчезновение | 3                | 1          | Любим Мерлина    |
| 1                   | 1               | 2              | Мерлин         | 1000          | Клуб только Мерлина   | 10                 | Исчезновение | 3                | 1          | Любим Мерлина    |
| 1                   | 1               | 1              | Не Мерлин      | 100           | Клуб Мерлин           | 10                 | Исчезновение | 3                | 1          | Любим Мерлина    |
| 1                   | 1               | 3              | Мерлин         | 1000          | Клуб вообще не Мерлин | 10                 | Исчезновение | 3                | 2          | Не любим Мерлина |

Получена 1 НФ.

- Есть универсальное отношение.
- Есть контрольный пример.
- Есть первичный ключ.
- Есть атомарные значения.

Перед переходом к 2 НФ нужно описать, с какими проблемами мы столкнемся, если останемся на 1 НФ.

Пример:

- Волшебник, который не состоит в клубах и не использует трюки. Такого волшебника не получится занести. Это называется __аномалией добавления__.
- __Аномалия удаления__: при удалении сведений о единственном волшебнике в клубе удаляется информация о клубе.
- __Аномалия изменения__: если волшебник сменит имя, то надо обновлять N строк, в которых он содержится.

Переход с 1 НФ к 2 НФ - устранение частичных ФЗ.

__Частичные ФЗ__ - зависимости от части первичного ключа.

То, что зависит от части первичного ключа, надо вывести в отдельную таблицу.

Т. е. нужно создать отдельные таблицы для этого.

Берем сочетания по одному:

Волшебники:

| __ИД волшебника__ | Имя волшебника | размер ПО |
| ----------------- | -------------- | --------- |

Трюки:
| __Код трюка__ | описание | степень крутости |
| ------------- | -------- | ---------------- |

Клубы:
| __Код клуба__ | название | ИД гильдии | название гильдии |
| ------------- | -------- | ---------- | ---------------- |

Трюки волшебников:
| __ИД волшебника__ | __код трюка__ | мастерство |
| ----------------- | ------------- | ---------- |

Волшебники в клубах:
| __ИД волшебника__ | __ИД клуба__ |
| ----------------- | ------------ |

Можно разбить отношения по 3 на отношения по 2, а затем их разбить на отношения по 1 (на контрольной).

Получили отношение во 2 НФ.

Устранили частичные ФЗ.

Проблемы:

- __Аномалия добавления__: нельзя добавить гильдию, у которой нет ни одного клуба.
- __Аномалия удаления__: если в гильдии был только один клуб, при его удалении удалится и гильдия.
- __Аномалия изменения__: при изменении названии гильдии нужно обновить много строк.

Для решения проблем нужно перейти к 3 НФ, а для этого нужно устранить транзитивные функциональные зависимости.

__Транзитивная ФЗ__ - зависимость неключевых атрибутов от других неключевых атрибутов.

ПО ИД клуба определяем ИД гильдии, а по нему название гильдии.

Клубы:
| __Код клуба__ | название | ИД гильдии |
| ------------- | -------- | ---------- |

Гильдии:
| __ИД гильдии__ | Название гильдии |
| -------------- | ---------------- |

Получили 3 НФ.

Причем первичным ключом таблицы "Гильдии" становится тот атрибут, по которому делали "шажок".
