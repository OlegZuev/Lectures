# Лекция 6

19.02.20

- [Лекция 6](#Лекция-6)
  - [Продолжение](#Продолжение)
  - [Частичная ФЗ](#Частичная-ФЗ)
  - [Правило построения 2 НФ](#Правило-построения-2-НФ)
  - [3 НФ](#3-НФ)
  - [Правило построения 3 НФ](#Правило-построения-3-НФ)
    - [Правила работы со вложенными ФЗ](#Правила-работы-со-вложенными-ФЗ)
  - [Последний шаг](#Последний-шаг)

## Продолжение

Таким образом, отношение находится 1 НФ, если в нем устранены повторяющиеся группы данных и правильно определен первичный ключ на основе выявленных функциональных зависимостей.

1. Заполнить контрольный пример.
2. Выявить все ФЗ.
3. Определить первичный ключ.

Для определения ФЗ двигаемся слева направо.

- номер счет фактуры, шифр товара -> ...все.
- номер счет фактуры -> дата, код поставщика, название поставщика, адрес поставщика, код банка, название банка, адрес банка, ИНН банка, номер счета.
- код поставщика -> название поставщика, адрес поставщика, код банка, название банка, адрес банка, ИНН банка, номер счета.
- код банка -> название банка, адрес банка, ИНН банка.
- шифр товара -> название товара, единица измерения.

На втором шаге разбираем зависимости между неключевыми атрибутами. На третьем шаге - между ключевыми атрибутами.

Все таблицы, в т. ч. исходная ("Счет-фактура"), промежуточная, результирующие должны быть обязательно должны быть поименованы, т. к. для получения лучшей схемы БД с точки зрения отсутствия аномалий при включении, удалении и изменении данных необходимо соблюдать обратимость процесса декомпозиции (т. е. в обратном порядке, начиная с результата, надо, используя композицию, получить все схемы промежуточных и, в конечном счете, исходного отношений без потерь).

__Замечание.__ Для этого удобно заполнять все промежуточные таблицы данными (если дома).

## Частичная ФЗ

Для перехода ко 2 НФ на втором шаге проектирования необходимо устранить т. н. частичные ФЗ.

__DEF.__ Говорят, что в отношении f имеется __частичная ФЗ__, если среди списка выявленных на предыдущем шаге ФЗ есть такие, в которых некоторые атрибуты __однозначно__ зависят не от всего ключа в целом, а от некоторой его части.

Номер счет фактуры и шифр товара - частичные ФЗ.

## Правило построения 2 НФ

Для того, чтобы устранить частичную ФЗ, надо выделить в отдельные отношения те неключевые атрибуты, которые зависят от некоторой части первичного ключа вместе с этой частью, а в исходном отношении оставить без изменения его первичный ключ и только те неключевые атрибуты, которые зависят целиком от первичного ключа, а не от его части.

Частичные зависимости могут быть вложенные.

Мы должны разбить исходное отношение на несколько. Надо выписать в отдельное отношение.

Отношения надо именовать либо в единственном числе, либо во множественном.

- Номер счет фактуры -> дата, код поставщика, название поставщика, код банка, название банка, адрес банка, ИНН банка, номер счета. Отношение "Шапка счет-фактуры".
- Шифр товара -> ..., цена за единицу. Отношение "Товар".
- Номер счет-фактуры, шифр товара -> номер счета, шифр, цена, кол-во. Отношение "Счет-фактура".

## 3 НФ

В нашем примере во 2 НФ, которая представляет собой 1 НФ после устранения частичных зависимостей, уже пропали аномалии, связанные со вставкой, удалением и изменением данных о товаре, но остались аномалии, связанные с данными о реквизитах поставщиков и банков, т. к. в нашем примере имеются транзитивные ФЗ. Более того, они вложенные.

Пусть A, B, C - некоторые атрибуты отношения R. Говорят, что C - __транзитивно зависит__ от A (A ->-> C), если B - ФЗ от A (A -> B), C - ФЗ от B (B -> C), и при этом обратная ФЗ отсутствуют.

Отношение находится в __3 НФ__, если оно находится во 2 НФ и в нем отсутствуют транзитивные ФЗ.

## Правило построения 3 НФ

Для того, чтобы построить 3 НФ, надо выделить в отдельное отношение те __неключевые__ атрибуты, которые входят в состав транзитивной ФЗ, приписать имена новым отношениям и определить для них новые первичные ключи, а в исходном отношении от выделенных по-прежнему в качестве неключевого атрибута остается только тот атрибут, который стал первичным ключом нового отношения (для связи).

    Например: (A -> B, C), (B -> C). В данном случае B и C нужно выделить в отдельное отношение и поименовать. В таблице останется только B.

Уже находятся в 3 НФ:

- Шифр товара -> ..., цена за единицу. Отношение "Товар".
- Номер счет-фактуры, шифр товара -> номер счета, шифр, цена, кол-во. Отношение "Счет-фактура".

### Правила работы со вложенными ФЗ

Для того, чтобы устранить вложенные ФЗ (частичные, транзитивные), необходимо __последовательно__ выполнить правила нормализации на соответствующем шаге поэтапно, начиная с самой объемлющей ФЗ.

В нашем примере есть 2 транзитивные зависимости, причем зависимость, где ключевым атрибутом является код банка, вложена в зависимость, где ключевым атрибутом является код поставщика.

Ключевые атрибуты, которые входят в ФЗ.

Разобьем отношение "Шапка счет фактуры":

Отношение "Шапка счет-фактуры": номер счет-фактуры*, дата, код поставщика. 3 НФ.

Отношение "Поставщик": код поставщика*, название поставщика, адрес поставщика, код банка, название банка, адрес банка, ИНН, номер счета. Есть транзитивная ФЗ. Его надо разбить.

Отношение "Банк": код банка*, название банка, адрес банка, ИНН. 3 НФ.

Отношение "Поставщик": код поставщика*, название поставщика, адрес поставщика, код банка, номер счета. 3 НФ.

## Последний шаг

"3 НФ" + только результирующее отношение.

- Счет-фактура: номер с-ф*, шифр*, кол-во, цена.
- Шапка с-ф: номер с-ф*, дата, код поставщика.
- Товар: шифр*, название, единица измерения.
- Поставщик: код поставщика*, название поставщика, адрес поставщика, номер счета, код банка.
- Банк: код банка*, название банка, адрес банка, ИНН.

После записи результата надо проверить его правильность путем последовательной композиции до исходного отношения, соединяя отношения, используя внешние ключи.

Аномалий нет.
