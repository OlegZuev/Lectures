# Лекция 5

12.02.20

- [Лекция 5](#Лекция-5)
  - [Реляционное проектирование](#Реляционное-проектирование)
  - [Требования к первичному ключу](#Требования-к-первичному-ключу)
  - [Свойства реляционного отношения, которые надо учитывать при проектировании](#Свойства-реляционного-отношения-которые-надо-учитывать-при-проектировании)
  - [Первая нормальная форма](#Первая-нормальная-форма)
    - [Аномалии первой НФ](#Аномалии-первой-НФ)
      - [ФЗ](#ФЗ)

## Реляционное проектирование

Требования к контрольному примеру:

1. Количество строк зависит от специфики предметной области и должно отражать все типичные проявления примеров данных с точки зрения типовых ситуаций, их разнообразия и взаимосвязи между данными.

    _На контрольной надо писать так, как писали на лекции!_

    Исходя из постановки ситуации в нашем примере к таким типовым ситуациям относятся тот факт, что сведения о товарах, их цене и количестве мы узнаем только из счет-фактуры (не из прайс-листа).

    В качестве аналога информационного объекта "счет-фактура" можно рассматривать чеки в сетевых магазинах. И тогда становится понятно, что в одной счет-фактуре чаще всего не одна строчка про товары, а много про разные товары, т. к. товары повторяются.

    Итак, дата является таким же атрибутом, как и все остальные, и от нее ничего не зависит. Все зависит от счет-фактуры.

    __Замечание!__ Важно понимать, что многие организации не могут позволить себе эксплуатацию Data Warehousing (хранилища данных), поэтому часто на практике используется и реляционный подход к проектированию, и реляционная модель для хранения исторических данных, т. е. в этом случае дата играет существенную роль и входит в составной первичный ключ как часть, потому что это своего рода "открытый архив", в котором от даты зависит и цена, и кол-во.

    В таком случае реляционный подход к проектированию на основе теории нормализации также работает (на контрольной будут именно такие примеры, в дз тоже, хотя в книжках чаще всего показывают примеры нормализации для онлайн БД).

    ONLINE.

    MOLAP - analytical processing.

    ROLAR - столбцы с аналитикой.

    HOLAP - комбинация вышеперечисленного.

    В одной счет-фактуре цена может быть разной. В один день один товар или разные товары могут поставлять одному и тому же получателю разные поставщики, и ясно, что с разной ценой и количеством (можно рассматривать случай, когда _случайно_ разные поставщики поставили один и тот же товар по той же цене в том же количестве как частный случай разных цен и количества).

    Т. к. поставщики работают с получателем по условиям задачи только через один банк и один счет в этом банке, то сведения о поставщике однозначно определяют реквизиты банка, но разные поставщики могут иметь такой счет как в одном и том же, так и в разном банках.

    С течением времени реквизиты и банка, и поставщика могут меняться, но у нас хоть и хранятся исторические данные, эти реквизиты известны только из счет-фактур, поэтому мы относимся к ним как к онлайн-данным, т. е. они могут изменяться, но хранится только актуальное значение.

2. Контрольный пример заполняется необязательно реальными данными, но обязательно данными, соответствующего реальным типа и диапазона допустимых значений. Например, адрес может быть "А1", фамилия - "Ф1".

## Требования к первичному ключу

__Первичный ключ__ - минимальная совокупность атрибутов, однозначно определяющая любой кортеж отношения (т. е. строчку таблицы).

1. Уникальность.
2. Неизменяемость. Значение не должно меняться с течением времени.
3. Краткость. Первичный ключ желательно делать числовым (целочисленным), т. к. это очень сильно влияет на эффективность SQL запросов.

Под эти требования абсолютно подходят т. н. искуственные ключи. Поэтому, естественный ключ, подпадающий под заданные требования, не будет изменяться со временем (например, номер паспорта), то предпочтение при прочих равных условиях надо отдавать искуственным ключам в качестве первичных.

Обратная ситуация: сразу несколько естественных атрибутов претендуют на роль первичного ключа. Они все объявляются candidate key, и только один из них выбирается в качестве primary key, который наиболее логичен в этой предметной области. Все остальные определяются по нему.

## Свойства реляционного отношения, которые надо учитывать при проектировании

1. Атомарность значения атрибута (атрибутов). Т. е. нельзя далее разбить значение атрибута на составляющие без потери смысла.

    Адрес состоит из множества частей, но хранится в одном поле, т. к. используется целиком.

2. Уникальность строк.
3. Порядок строк и столбцов несущественен (именно поэтому при проектировании надо так упорядочить столбцы, чтобы они были естественными для анализа и выявления повторяющихся групп данных).
4. Не должно быть принципиально пустых строк и пустых значений.

С точки зрения операций надо не забывать, что операции делаются целиком над строками.

Таблица в 1 НФ

| Номер счет-фактуры* | Дата     | Название поставщика | Адрес поставщика | Код банка | Название банка | Адрес банка | ИНН банка | Счет в банке | Номер товара* | Название товара | Единица изменения | Количество | Цена |
| ------------------- | -------- | ------------------- | ---------------- | --------- | -------------- | ----------- | --------- | ------------ | ------------- | --------------- | ----------------- | ---------- | ---- |
| 1                   | 01.01.20 | Кама                | А1               | 1         | Звезда         | А2          | 11111     | 11111        | 1             | Болт            | шт                | 10         | 10   |
| 1                   | 01.01.01 | Кама                | А1               | 1         | Звезда         | А2          | 11111     | 11111        | 1             | Болт            | шт                | 1          | 0    |
| 1                   | 01.01.01 | Кама                | А1               | 1         | Звезда         | А2          | 11111     | 22222        | 2             | Гвозди          | шт                | 1          | 0    |
| 1                   | 02.01.01 | Лена                | А4               | 1         | Солнце         | А2          | 11111     | 4444         | 1             | Болт            | шт                | 1          | 0    |
| 1                   | 01.01.20 | Лена                | А4               | 1         | Звезда         | А2          | 11111     | 11111        | 1             | Болт            | шт                | 4.5        | 200  |

Для определенности будем считать, что реквизиты банков не меняются со временем, но ошибки ввода могут происходить.

## Первая нормальная форма

__DEF.__ Отношение находится в __первой нормальной форме__, если в нем устранены повторяющиеся группы данных и правильно определен первичный ключ исходного отношения.

Под повторяющейся группой данных понимают группу данных одной структуры, но без дубликатов строк и их значений в данной группе.

Например: ФИО матери и данные об ее детях. У них не будет строк дубликатов.

Для каждой группы существует связанная с ней строка данных в исходной таблице.

В нашем примере это данные из шапки счет-фактуры: у нас будет столько строк про фактуру, сколько товаров во фактуре.

Избавляются от повторяющихся групп простым дублированием значений, связанных с группой данных, так, чтобы не было пустых значений в атрибутах. Это помогает правильно определить публичный ключ и выявить функциональные зависимости (ФЗ).

\* - первичный ключ.

__Замечание!__ От атрибутов типа "название" практически ничего не зависит, если для соответствующего информационного объекта заведет код, id и т. д.

Не бывает отношений без имен!

Мы получили 1 НФ.

### Аномалии первой НФ

Аномалии вставки: нельзя вставить данные о новом поставщике, банке, товаре, пока не будут занесены данные о новой счет-фактуре.

Аномалии удаления: при удалении данных о какой-то счет-фактуре могут быть потеряны данные о банке, поставщике, товаре, если эти данные содержались только в удаляемой счет-фактуре.

Аномалии изменения: при изменении данных в реквизитах банка, поставщика, товара требуется сканировать всю БД и вносить эти изменения во все записи счет-фактур.

Для того, чтобы устранить эти аномалии, требуется (1) выявить все функциональные зависимости между данными и (2) перейти к нормальной форме.

Рекомендуется первую ФЗ писать полную ФЗ, в которую входят все атрибуты исходного отношения.

__DEF.__ пусть А и Б - 2 набора атрибутов из отношения Ф. Говорят, что Б функционально зависит от А (или А функционально определяет Б), если в любой момент времени любому набору значений из А соответствует ровно один набор значений из Б.

#### ФЗ

1. Ключ счет-фактуры, номер товара - А

    Все остальное (дата, код поставщика, адрес поставщика, код банка, наименование банка, адрес банка, ИНН, номер счета, наименование товара, единица измерения, количество, цена) - Б

2. ... - код поставщика, наименование поставщика, код банка, наименование банка, адрес банка, ИНН, номер счета.

3. Код поставщика - наименование поставщика, адрес поставщика, код банка, наименование банка, ИНН, счет банка.

4. Код банка - название банка, адрес банка, ИНН.

5. Шифр товара - наименование, единицу измерения
