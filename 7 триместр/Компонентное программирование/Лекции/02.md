# Лекция 2

10.09.20

- [Лекция 2](#лекция-2)
  - [Модель "клиент-сервер"](#модель-клиент-сервер)
  - [Технология COM](#технология-com)
  - [Базовые понятия](#базовые-понятия)
  - [Спецификация COM](#спецификация-com)
  - [Определение интерфейса](#определение-интерфейса)
  - [Стандартные интерфейсы](#стандартные-интерфейсы)
    - [IUnknown](#iunknown)
    - [IClassFactory](#iclassfactory)
    - [IDispatch (диспетчерские интерфейсы и автоматизация)](#idispatch-диспетчерские-интерфейсы-и-автоматизация)
  - [Включение и агрегирование внутренних компонентов](#включение-и-агрегирование-внутренних-компонентов)
  - [Взаимодействие клиента с сервера](#взаимодействие-клиента-с-сервера)
    - [In-process (DLL)](#in-process-dll)
    - [Out-of-process (exe-файл)](#out-of-process-exe-файл)
  - [Библиотеки типа](#библиотеки-типа)
  - [План разработки компонента](#план-разработки-компонента)
  - [Развитие технологии COM](#развитие-технологии-com)

## Модель "клиент-сервер"

Синхронное и асинхронное взаимодействие:

- Синхронное - клиент ожидает ответа на запрос.
- Асинхронное - клиент остается интерактивным.

## Технология COM

Проблемы при использовании DLL:

- потребуется документация
- сложности использования памяти различными модулями
- проблема при обращению к объекту, созданному другим приложением
- проблема при передаче двоичных данных от одного приложения к другому
- поиск установленной копии приложения, реализующего требуемые сервисы, и корректная его инициализация
- обеспечение корректной работы приложения-сервера одновременно с несколькими клиентами
- управление памятью, выгрузка из памяти приложения-сервера, когда необходимость в нем отпадет и, наоборот, предотвращение несвоевременной выгрузки

__COM__ - метод разработки программных компонентов - двоичных исполняемых файлов, которые предоставляют необходимые сервисы приложениям, операционным системам и другим интерфейсам.

__COM__ - это спецификация. Она указывает как создавать динамически взаимозаменяемые компоненты.

Требования к компонентам:

- динамическая компоновка

    Приложение, созданное из компонентов, которые должны _статически перекомпилироваться_ каждый раз при необходимости внести изменения, _эквивалентно монолитному приложению_.

## Базовые понятия

__Клиент__ - программа или компонент, использующий другой компонент.

Клиент подсоединяется к компоненту через _интерфейс_. Если компонент _изменяется без изменения интерфейса_, то изменения в _клиенте не требуются_.

## Спецификация COM

Спецификация COM (Component Object Model) определяет общую схему для создания компонентов.

Спецификация определяет:

- как из компонента создается объект
- как клиент обращается к возможностям, предоставляемым объектом
- ответственность объекта за уничтожение себя, когда он более не используется

Все эти действия обрабатываются _интерфейсами_, которые существенно упрощают использование возможностей сервера.

В состав COM входит библиотека API, которая предоставляет сервисы управления компонентами.

Для инициализации используется CoInitialize/OleInitialize, для деинициализации - CoUninitialize.

## Определение интерфейса

__Интерфейс DLL__ - набор функций, экспортируемых ею.

__Интерфейс класса C++__ - набор публичных членов данного класса.

__Интерфейс COM__ - не только набор функций, но и определенная структура в памяти, содержащая массив указателей на функции, где каждый элемент массива содержит адрес функции, реализуемой компонентом.

Каждый компонент может поддерживать множество интерфейсов.

## Стандартные интерфейсы

### IUnknown

Спецификация COM требует обеспечения следующих функциональных возможностей всех объектов:

- объект должен быть способен отслеживать установленные с ним соединения; если объект больше не используется, он должен быть способен уничтожить себя;
- объект должен допускать запросы от клиентов на дополнительные интерфейсы, которые он может поддерживать.

Для обеспечения всех этих возможностей все объекты имеют встроенный интерфейс IUnknown. Интерфейс IUnknown должен поддерживаться каждым объектом COM.

Каждый объект должен включать функциональные возможности интерфейса IUnknown.

Интерфейс IUnknown:

- AddRef
- Release
- QueryInterface

```cpp
class IUnknown
{
public:
    virtual HRESULT QueryInterface(REFID riid, void** ppv) = 0;
    virtual ULONG AddRef() = 0;
    virtual ULONG Release() = 0;
}
```

__GUID__ - 128-битные числа, которые генерируются с использованием алгоритма, гарантирующего их уникальность.

Системный реестр хранит информацию о компонентах.

### IClassFactory

__Фабрики классов__ - объекты COM, создающие другие объекты сервера. Каждый COM-объект должен в соответствии со стандартом иметь связанную с ним фабрику классов, которая ответственна за его создание.

Фабрика классов реализует функциональность COM-интерфейса IClassFactory

### IDispatch (диспетчерские интерфейсы и автоматизация)

__Автоматизация__ - другой способ управления компонентом. Автоматизация - надстройка над COM.

__Сервер автоматизации__ - это компонент COM, который реализует интерфейс IDispatch.

__Контроллер автоматизации__ - это клиент COM, взаимодействующий с сервером через интерфейс IDispatch.

## Включение и агрегирование внутренних компонентов

Включение и агрегирование компонентов позволяет настраивать и подстраивать уже существующие компоненты.

## Взаимодействие клиента с сервера

### In-process (DLL)

Взаимодействие между клиентом и компонентом обеспечивает наиболее эффективный обмен информацией.

### Out-of-process (exe-файл)

Схема взаимодействия более сложна, так как соединение должно пересечь границы процесса (особенно на удаленном компьютере).

Пример: RPC.

## Библиотеки типа

__Библиотека типа__ - независимый от языка эквивалент заголовочных файлов.

Библиотека типа COM предоставляет информацию типа о компонентах, интерфейсах, методах, свойствах, аргументах и структурах.

__Библиотека типа__ - это откомпилированная версия файла IDL, к которой возможен доступ из программы. Это двоичный файл.

Библиотека автоматизации предоставляет стандартные компоненты для создания и чтения двоичных файлов.

## План разработки компонента

1. Разработать класс и реализовать в нем все необходимые интерфейсы.
2. Разработать фабрику класса для его активизации по запросу клиента.
3. Реализовать экспортные функции DllGetClassObject() и DllCanUnloadNow().
4. Создать регистрационный файл для внесения изменений в реестр Windows информации о разработанном компоненте.

## Развитие технологии COM

__Технология DCOM__ (Microsoft Distributed Component Object).

COM+ - службы для создания и развертывания компонентов в бизнес-среде:

- служба транзакций
- служба асинхронных сообщений
- служба безопасности
- служба пула объектов
